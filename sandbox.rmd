---
title: "Sandbox"
author: "Scott Large and Nadia Nord"
date: "15 March 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown Introduction

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


### Aggregate data

Our first task is to query Stock Assessment Graphs web services via [icesSAG](https://github.com/ices-tools-prod/icesSAG) for stock status table, description (stock name) and stock code.

```{r SAG}
library(icesSAG, echo = FALSE)

## Look at the help files of functions like this: (Note, you have to load the package using the library() function, first)
?getListStocks()

## Look at the data for 2017 to make sure everything loads, OK.
head(getListStocks(year = 2017))

## Assign the data to a new variable, named 'dat'
dat <- getListStocks(year = 2017)

## We want to sort only the published stocks. Two ways to do this:
p_dat_base <- dat[dat$Status == "Published",]

# or via dplyr "pipes"
library(dplyr)
p_dat_pipes <- dat %>% 
  filter(Status == "Published")

# See they're identical!
all(p_dat_pipes == p_dat_base)

## We can also modify things in a dplyr pipe using mutate(), select(), and other verbs
dat %>% 
  mutate(FishStockName = toupper(FishStockName)) %>% #Makes all letters upper case
  select(FishStockName) %>% 
  head()
```

We also need to use the Stock Database. The easiest way to access the Stock Database is with jsonlite package

```{r SD}
library(jsonlite)
rawsd <- fromJSON("http://sd.ices.dk/services/odata3/StockListDWs3?$filter=ActiveYear%20eq%202017")$value 

rawsd %>% 
  filter(StockCode %in% unique(dat$FishStockName)) %>% 
  head()

```

## Task: 
The final table we want will look like this:

| Stock code | Description                                                        | Data category | Advice value (tonnes) | Stock status   |
|------------|--------------------------------------------------------------------|---------------|-----------------------|----------------|
| alf-comb   | Alfonsinos/Golden eye perch (Beryx spp.) in the Northeast Atlantic | 5             | 12345                 | table from SAG |

1. Create a data frame (from the two data sources) that will produce columns 1-3. You will need to merge the data sources together using either merge() or dplyr::left_join() 

hint: you will need to change the column names between the two data sources because they may not be the same. Also, make sure that values in the columns you are trying to merge on are consistent (e.g., Aab-123 is different from aab-123).




