---
title: ''
output:
  html_document:
    css: styles.css
---

```{r setup, include = FALSE}
library(icesSAG)
library(dplyr)
library(DT)
library(purrr)
library(xml2)
library(jsonlite)
library(stringr)
# library(docxtractr)
```



```{r DT, echo = FALSE, message = FALSE}

## TODO:

## Check SAG connection

## If cache is not present, download all 2017 stock status

## If cache is present, download all new stocks

## If no new stocks stop()

## 


summaryTableFun <- function(AssessmentKey) {
  imageURL <- sprintf("http://standardgraphs.ices.dk/StandardGraphsWebServices.asmx/getStockStatusTable?AssessmentKey=%s", AssessmentKey) %>%
    read_xml() %>% 
    xml_text()
  sprintf('<a href="%s" target="_blank"><img src="%s" height="100%%" width="100%%"></img>', imageURL, imageURL)
}

year <- 2017

stock_dat<- fromJSON("http://internalservices.ices.local:60/api/SDInternalDWs") %>% 
  filter(ActiveYear == year,
         Published == TRUE) %>% 
  select(StockCode = StockKeyLabel,
         EcoRegion,
         DataCategory,
         AdviceCategory
         # AdviceValue
  ) %>% 
  mutate(StockCode = gsub(pattern = "\u2013", "-", StockCode)) %>% # remove en dashes in favor of hyphens
  distinct(.keep_all = TRUE)

stock_list <- icesSAG::getListStocks(year) %>% 
  filter(Status == "Published") %>% 
  select(StockCode = StockKeyLabel,
         Description = StockDescription,
         SpeciesName,
         AssessmentKey
         # AdviceValue
  ) %>% 
  mutate(Description = gsub(pattern = "\u2013", "-", Description), # remove en dashes in favor of hyphens,
         Description = gsub(pattern = "Micromesistius poutasso",
                            "Micromesistius poutassou", Description), # misspelled blue whiting
         Description = gsub(pattern = "Solea spp.",
                            "Solea solea", Description), # wrong description for sole
         Description = gsub(pattern = "Platichtys flesus",
                            "Platichthys flesus", Description),
         Description = gsub(pattern = "Lophius piscatorius and L. budegassa",
                            "Lophius piscatorius and Lophius budegassa", Description),
         Description = ifelse(StockCode == "had-iris",
                              "Haddock (Melanogrammus aeglefinus) in Division7.a (Irish Sea)",
                              Description),
         SpeciesName = recode(SpeciesName,
                              "Mustelus asterias" = "Mustelus"),
         StockCode = gsub(pattern = "\u2013", "-", StockCode), # remove en dashes in favor of hyphens,
         StockCode = ifelse(StockCode == "had-iris",
                            "had.27.7a",
                            StockCode),
         StockCode = ifelse(StockCode == "sbr-x",
                            "sbr.27.10",
                            StockCode)) %>% 
  left_join(stock_dat, by = "StockCode")

stock_list_frmt <- bind_rows(
  # Normal binomial names
  stock_list %>%
    filter(grepl("[[:space:]]", SpeciesName)) %>%
    mutate(Description = stringr::str_replace_all(string = Description,
                                                  pattern = SpeciesName,
                                                  replacement = paste0("<em>", SpeciesName, "</em>"))),
  # Groups of species (.spp)
  stock_list %>%
    filter(grepl(" spp.*$", Description)) %>%
    mutate(Description = stringr::str_replace_all(string = Description,
                                                  pattern = SpeciesName,
                                                  replacement = paste0("<em>", SpeciesName, "</em>"))),
  # A bit different notation (embedded in 2 sets of parentheses)
  stock_list %>%
    filter(StockCode %in% c("raj-mar", "raj.27.1012")) %>%
    mutate(Description = stringr::str_replace_all(string = Description,
                                                  pattern = "Raja clavata",
                                                  replacement = "<em>Raja clavata</em>")),
  
  # The "others" with no species name
  stock_list %>%
    filter(!grepl(" spp.*$", Description)) %>%
    filter(!StockCode %in% c("raj-mar", "raj.27.1012")) %>%
    filter(!grepl("[[:space:]]", SpeciesName))
)

if(nrow(stock_list) != nrow(stock_list_frmt)) stop("Number of rows different when formatting")

stock_list_frmt %>% 
  mutate(StockUrl = sprintf("http://ices.dk/sites/pub/Publication%%20Reports/Advice/%s/%s/%s.pdf",
                            year,
                            year,
                            StockCode),
         StockCode  = sprintf('<a href="%s" target="_blank">%s</a>', 
                              StockUrl,
                              StockCode),
         AdviceValue = 12345, # link from /advice2017/released_advice
         DataCategory = signif(as.numeric(DataCategory), 1),
         StockStatus = purrr::map(AssessmentKey, summaryTableFun)) %>% 
  select(`Stock code` = StockCode,
         # Release date
         Description,
         `Data category` = DataCategory,
         `Advice value (tonnes)` = AdviceValue,
         `Stock Status` = StockStatus) %>% 
  DT::datatable(., 
                escape = FALSE,
                rownames = FALSE,
                caption = htmltools::tags$caption(
                  style = 'caption-side: bottom; text-align: center;',
                  htmltools::em(paste0("This table was last updated on ", 
                                       format(Sys.Date(), "%d %B %Y"), ".")
                  )
                ),
                options = list(
                  dom = 'tip',
                  ordering = TRUE,
                  scrollX = FALSE,
                  autoWidth = TRUE,
                  columnDefs = list(list(width = '500px',
                                         targets = 4)
                  )
                )
  )
```
