---
title: ''
output:
  html_document:
    css: styles.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(icesSAG)
library(dplyr)
library(DT)
library(purrr)
library(xml2)
library(jsonlite)
library(stringr)
library(docxtractr)
```



```{r, echo = FALSE}

summaryTableFun <- function(key) {
  tt <- sprintf("http://standardgraphs.ices.dk/StandardGraphsWebServices.asmx/getStockStatusTable?key=%s", key) %>%
    read_xml() %>% 
    xml_text()
  sprintf('<a href="%s" target="_blank"><img src="%s" height="100%%" width="100%%"></img>', tt, tt)
}

year <- 2017

rawsd <- fromJSON(sprintf("http://sd.ices.dk/services/odata3/StockListDWs3?$filter=ActiveYear%%20eq%%20%s", 
                          year))$value 

# Format the species names appropriately
slFull <- bind_rows(
  # Normal binomial names
  rawsd %>%
    filter(!grepl(" spp", Description),
           StockCode != "ANG",
           grepl("[[:space:]]", SpeciesScientificName)) %>%
    mutate(Description = str_replace_all(string = Description,
                                         pattern = SpeciesScientificName,
                                         replacement = paste0("<em>", SpeciesScientificName, "</em>"))),
  # Anglerfish (w/ two species)
  rawsd %>%
    filter(StockCode == "ANG") %>%
    mutate(Description = str_replace_all(string = Description,
                                         pattern = "Lophius piscatorius and L. budegassa",
                                         replacement = "<em>Lophius piscatorius</em> and <em>L. budegassa</em>")),
  # Groups of species (.spp)
  rawsd %>%
    filter(grepl(" spp.*$", Description)) %>%
    mutate(Description = str_replace_all(string = Description,
                                         pattern = SpeciesScientificName,
                                         replacement = paste0("<em>", SpeciesScientificName, "</em>"))),
  # A bit different notation (embedded in 2 sets of parentheses)
  rawsd %>%
    filter(StockCode == "raj-mar") %>%
    mutate(Description = str_replace_all(string = Description,
                                         pattern = "Raja clavata",
                                         replacement = "<em>Raja clavata</em>")),
  # The "others" with no species name
  rawsd %>%
    filter(StockCode != "ANG") %>%
    filter(!grepl(" spp", Description)) %>%
    filter(StockCode != "raj-mar") %>%
    filter(!grepl("[[:space:]]", SpeciesScientificName))
)



getListStocks(year = year) %>%
  filter(Status == "Published") %>%
  mutate(StockCode = tolower(FishStockName)) %>% 
  left_join(slFull, by = c("FishStockName" = "StockCode")) %>%
  mutate(StockUrl = sprintf("http://ices.dk/sites/pub/Publication%%20Reports/Advice/%s/%s/%s.pdf",
                            year,
                            year,
                            StockCode),
         StockCode  = sprintf('<a href="%s" target="_blank">%s</a>', 
                              StockUrl,
                              StockCode),
         AdviceValue = 12345, # link from /advice2017/released_advice
         DataCategory = signif(as.numeric(DataCategory), 1),
         StockStatus = purrr::map(key, summaryTableFun)) %>% 
  select(`Stock code` = StockCode,
         # Release date
         Description,
         `Data category` = DataCategory,
         `Advice value (tonnes)` = AdviceValue,
         `Stock Status` = StockStatus) %>% 
  DT::datatable(., 
                escape = FALSE,
                rownames = FALSE,
                caption = htmltools::tags$caption(
                  style = 'caption-side: bottom; text-align: center;',
                  htmltools::em(paste0("This table was last updated on ", 
                                       format(Sys.Date(), "%d %B %Y"), ".")
                  )
                ),
                options = list(
                  # dom = 't',
                  ordering = TRUE,
                  scrollX = FALSE,
                  autoWidth = TRUE,
                  columnDefs = list(list(width = '500px',
                                         targets = 4)
                  )
                )
  )
```